generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @map("_id")
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          String    @default("user") // "user" or "admin"
  isBlocked     Boolean   @default(false) // User is completely blocked from the app
  blockedAt     DateTime? // When the user was blocked
  blockedBy     String? // Admin who blocked the user
  blockedReason String? // Reason for blocking
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions Session[]
  accounts Account[]
  chats    Chat[]
}

model Session {
  id        String   @id @map("_id")
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                    String    @id @map("_id")
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Verification {
  id         String   @id @map("_id")
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Chat {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  title     String?
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Human Review Blocking (Layer 2)
  isHumanReviewBlocked Boolean   @default(false) // Chat blocked pending admin review
  humanReviewReason    String? // "hallucination" | "medical" | "self_harm" | "psychological"
  humanReviewMessageId String?   @db.ObjectId // The message that triggered the block
  humanReviewStatus    String? // "pending" | "approved" | "blocked" | "admin_response"
  humanReviewMessage   String? // User-facing message explaining the block
  humanReviewAdminId   String? // Admin who reviewed
  humanReviewResponse  String? // Admin's response content (for admin_response)
  humanReviewedAt      DateTime?
  humanReviewLocked    Boolean   @default(false) // Admin can only respond once
}

model Message {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  role        String // "user" | "assistant"
  content     String
  attachments Json? // Array of { type: "image" | "document", url: string, name: string }
  chatId      String   @db.ObjectId
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  // Layer 1 - Anomaly detection fields
  isBlocked        Boolean @default(false)
  isWarning        Boolean @default(false)
  safetyScore      Int?
  userEmotion      String? // Detected emotion for cumulative tracking
  emotionIntensity String? // "low", "medium", "high"

  // Layer 2 - Semantic analysis fields
  isPendingReview  Boolean @default(false) // AI response hidden, sent to admin
  accuracyScore    Int? // From Groq analysis
  semanticAnalysis Json? // Full Groq analysis result

  // Admin correction fields
  isAdminCorrected Boolean   @default(false)
  originalContent  String? // Original AI response before admin correction
  correctedBy      String? // Admin user ID who corrected
  correctedAt      DateTime?

  // User notification
  hasNotification  Boolean @default(false)
  notificationRead Boolean @default(false)

  anomalyLog AnomalyLog?
}

// CHAPAL - Anomaly Log for Admin Review
model AnomalyLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Reference to the flagged message
  messageId String  @unique @db.ObjectId
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  // User information
  userId    String
  userEmail String
  chatId    String @db.ObjectId

  // Detection details
  anomalyType      String // Primary anomaly type
  severity         String // "critical", "high", "medium", "low"
  layer            String  @default("deterministic") // "deterministic" or "semantic"
  userQuery        String // The original user message
  aiResponse       String? // The AI response (may be null if blocked before generation)
  detectionDetails Json // Full detection result
  safetyScore      Int
  accuracyScore    Int? // From Layer 2
  userEmotion      String

  // Review status
  status        String    @default("pending") // "pending", "approved", "blocked", "corrected"
  reviewedBy    String? // Admin user ID who reviewed
  reviewedAt    DateTime?
  adminResponse String? // Corrected response from admin (for "corrected" status)
  reviewNotes   String? // Admin notes about the review

  // Feedback loop
  feedbackApplied Boolean @default(false)
  feedbackNotes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
